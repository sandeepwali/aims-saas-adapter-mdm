namespace: aims-saas-adapter-mdm

helmCharts:
  - name: rabbitmq
    includeCRDs: false
    valuesInline:
      auth:
        tls:
          enabled: false
          # autoGenerated: true
          failIfNoPeerCert: false
          sslOptionsVerify: verify_none
          autoGenerated: false
          #existingSecret: rabbitmq-tls
          #existingSecretFullChain: true
        erlangCookie: XaimsREPLACEMEaimsREPLACEMEaimsX
        username: aims
        password: aims
      persistence:
        size: 128Gi
      resources:
        requests:
          cpu: 150m
          memory: 1Gi
        limits:
          cpu: 2850m
          memory: 6Gi
      memoryHighWatermark:
        enabled: true
        value: 0.667
      livenessProbe:
        enabled: false
      customLivenessProbe:
        exec:
          command:
            - sh
            - -ec
            - test "$(curl -f --user aims:$RABBITMQ_PASSWORD 127.0.0.1:15672/common/aims-saas-adapter-mdm/rabbitmq-management/api/healthchecks/node)"
              = '{"status":"ok"}'
        failureThreshold: 6
        initialDelaySeconds: 120
        periodSeconds: 30
        successThreshold: 1
        timeoutSeconds: 20
      readinessProbe:
        enabled: false
      customReadinessProbe:
        exec:
          command:
            - sh
            - -ec
            - curl -f --user aims:$RABBITMQ_PASSWORD 127.0.0.1:15672/common/aims-saas-adapter-mdm/rabbitmq-management/api/health/checks/local-alarms
        failureThreshold: 3
        initialDelaySeconds: 10
        periodSeconds: 30
        successThreshold: 1
        timeoutSeconds: 20
      extraConfiguration: |-
        default_vhost = aims-vhost
        default_permissions.configure = .*
        default_permissions.read = .*
        default_permissions.write = .*
        management.path_prefix = /common/aims-saas-adapter-mdm/rabbitmq-management/
    releaseName: aims-rabbitmq
    repo: https://charts.bitnami.com/bitnami

#resources:
#  - rabbitmq-tls.yaml

patchesJson6902:
  - target:
      version: v1
      kind: StatefulSet
      name: aims-rabbitmq
    patch: |-
      - op: remove
        path: /spec/template/spec/affinity/podAntiAffinity/preferredDuringSchedulingIgnoredDuringExecution/0/podAffinityTerm/namespaces
